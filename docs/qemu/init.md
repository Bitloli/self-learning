## QEMU 初始化过程分析

- qemu_init : 很长的参数解析
  - qemu_create_machine(select_machine()) : select_machine 中获取 MachineClass, 在这里抉择是 pc 还是 q35
    - cpu_exec_init_all :
      - io_mem_init : 初始化 `MemoryRegion` `io_mem_unassigned`, 用于捕获访问 io 空洞的行为, 实际上这个 mr 永远都不会被使用,
      - memory_map_init : 初始化 `system_memory` 和 `io_memory` 这两个分别是两个对顶级的 container 分别和 address_space_io 和 address_space_memory 关联起来
    - page_size_init
  - configure_accelerators
    - qemu_opts_foreach
      - configure_accelerator
        - accel_init_machine : 在 tcg_accel_class_init 的位置初始化
          - tcg_init
            - tcg_exec_init
              - cpu_gen_init
                - tcg_context_init : 在 xqm 下这个没有意义
              - page_init : 初始化
                - page_size_init
                - page_table_config_init
              - tb_htable_init
              - code_gen_alloc
                - alloc_code_gen_buffer
                  - alloc_code_gen_buffer_anon
              - tcg_prologue_init
            - tcg_region_init
  - qmp_x_exit_preconfig
    - qemu_init_board
      - create_default_memdev : 比想象的复杂一点，是因为实际上，RAM 还可以是 filebased
      - machine_run_board_init
        - `machine_class->init` : DEFINE_I440FX_MACHINE 这个封装出来 pc_init_v6_1 来调用
          - pc_init1
            - x86_cpus_init : 多次调用 x86_cpu_new 来创建新的 CPU
              - x86_cpu_new
                - qdev_realize : 经过 QOM 的 object_property 机制，最后调用到 device_set_realized
                  - device_set_realized
                    - x86_cpu_realizefn
                      - cpu_list_add
                      - cpu_exec_realizefn
                        - accel_cpu_realizefn
                          - kvm_cpu_realizefn
                          - tcg_cpu_realizefn : 主要就是 address space 的初始化
                            - cpu_address_space_init
                              - memory_listener_register
                                - tcg_commit
                        - tcg_exec_realizefn
                          - TCGCPUOps::initialize => tcg_x86_init: 这是 CPUClass 上注册的函数，进行一些 tcg 相关的的初始化, 例如 regs
                          - tlb_init
                            - tlb_mmu_init
                      - x86_cpu_expand_features
                      - x86_cpu_filter_features
                      - mce_init : machine check exception, 初始化之后，那些 helper 就可以正确工作了, mce 参考[^2]
                      - qemu_init_vcpu : 创建执行线程
                        - rr_cpu_thread_fn : 进行一些基本的注册工作，然后等待, 注意，此时在另一个线程中间了
                      - x86_cpu_apic_realize
                        - 通过 QOM 调用到 apic_common_realize
                           - 通过 QOM 调用 apic_realize
                        - 添加对应的 memory region
                      - X86CPUClass::parent_realize : 也就是 cpu_common_realizefn, 这里并没有做什么事情
          - pc_memory_init : 创建了两个 mr alias，ram_below_4g 以及 ram_above_4g，这两个 mr 分别指向 ram 的低 4g 以及高 4g 空间，这两个 alias 是挂在根 system_memory mr 下面的
            - e820_add_entry
            - pc_system_firmware_init : 处理 `-drive if=pflash` 的选项
              - x86_bios_rom_init : 不考虑 pflash, 这是唯一的调用者
                - memory_region_init_ram(bios, NULL, "pc.bios", bios_size, &error_fatal)
                - rom_add_file_fixed
                  - rom_add_file
                    - rom_insert
                    - add_boot_device_path
                - 还有两个 memory region 的操作, 将 bios 的后 128KB 映射到 ISA 空间，但是 bios 的大小是 256k 啊，其次，为什么映射到 pci 空间最上方啊
                  - [ ] map the last 128KB of the BIOS in ISA space
                  - [ ] map all the bios at the top of memory
            - memory_region_init_ram : 初始化 "pc.rom"
            - fw_cfg_arch_create : 创建 `FWCfgState *fw_cfg`, 并且初始化 e820 CPU 数量之类的参数, 具体参考 [fw_cfg](./fw_cfg.md)
            - rom_set_fw : 用从 fw_cfg_arch_create 返回的值初始化全局 fw_cfg
            - x86_load_linux : 如果指定了 kernel, 那么就从此处 load kernel
            - rom_add_option : 添加 rom 镜像，关于 rom 分析看 [loader](#loader)
          - pc_guest_info_init : 注册上 pc_machine_done 最后执行
          - smbios_set_defaults : 初始化一些 smbios 变量，为下一步制作 smbios table 打下基础
          - [ ] pc_gsi_create : 关于中断的事情可以重新看看狼书好好分析一下
          - i440fx_init : 只有 pcmc->pci_enabled 才会调用的
            - qdev_new("i440FX-pcihost") : 这当然会调用 i440fx_pcihost_initfn 和 i440fx_pcihost_class_init 之类的函数
              - i440fx_pcihost_initfn : 初始化出来 0xcf8 0xcfb 这两个关键地址
            - pci_root_bus_new : 创建 PCIBus
              - [ ] PCIHostState 和分别是啥关系 ? host bridge 和 bus 的关系 ?
              - qbus_create("pci")
                - qbus_create("pci")
                  - pci_root_bus_init
                    - 一些常规的初始化
                    - pci_host_bus_register : 将 PCIHostState 挂载到一个全局的链表上
                - qbus_init
              - pci_root_bus_init
            - 处理 PCI 的地址空间的映射初始化
            - init_pam
          - piix3_create
            - pci_create_simple_multifunction : 创建出来设备
            - 设置从 piix3 到 i440fx 的中断路由之类的事情
          - [ ] isa_bus_irqs
          - pc_i8259_create : 根据配置，存在多种选项
            - i8259_init
          - [ ] ioapic_init_gsi
          - [ ] pc_vga_init
            - pci_vga_init
            - isa_vga_init
          - pc_basic_device_init
            - ioport80_io 初始化
            - ioportF0_io 初始化
            - hpet 初始化 : hpet 不是
            - mc146818_rtc_init : 通过 QOM 调用 rtc_class_initfn 和 rtc_realizefn 之类的，进行 rtc 的初始化
            - i8254_pit_init
            - i8257_dma_init
            - pc_superio_init : https://en.wikipedia.org/wiki/Super_I/O
          - pc_nic_init : 网卡的初始化
          - pci_ide_create_devs
            - ide_drive_get
            - ide_create_drive
          - pc_cmos_init
            - 多次调用 rtc_set_memory 初始化 RTCState::cmos_data
          - piix4_pm_init : 当支持 acpi 的时候, 那么初始化电源管理
    - qemu_create_cli_devices
      - soundhw_init
      - parse_fw_cfg : 解析参数 -fw_cfg (Add named fw_cfg entry with contents from file file.)
      - usb_parse
      - device_init_func : 解析参数 -device 比如 nvme
    - qemu_machine_creation_done
      - qdev_machine_creation_done
        - notifier_list_notify : 通过 qemu_add_machine_init_done_notifier 的 references 可以很快的知道都注册了什么
          - pc_machine_done
            - [ ] x86_rtc_set_cpus_count : 神奇的机制，和 seabios 对称的看看
            - [ ] fw_cfg_add_extra_pci_roots
            - [ ] acpi_setup
              - 依赖于 acpi 的 `x86ms->fw_cfg` 和 pcms->acpi_build_enabled, 否则都会失败
          - tcg_cpu_machine_done : 注册 smram 相关的工作
          - [ ] machine_init_notify
    - qmp_cont : qmp_cont 可以作为一个通用的 qmp 函数来调用，让系统继续运行，当然也可以作为系统刚刚启动的效果
      - vm_start
        - vm_prepare_start
        - resume_all_vcpus
  - qemu_init_displays
  - accel_setup_post
  - os_setup_post
  - resume_mux_open
- qemu_main_loop
  - qemu_debug_requested
  - qemu_suspend_requested
  - qemu_shutdown_requested
  - qemu_reset_requested
  - qemu_wakeup_requested
